# Explore data

Now that's I've cleaned up the data a bunch, I'm going to explore some of the patterns in the data. I'm interested in how occurrence changes over time, when multiple last occurrences are in the same time bin, and geological unit lithological composition.

```{r import_clean, message = FALSE, results = 'hide'}

occur_collect <- read_csv(here::here('data', 'occurrences_clean.csv'))

# re-upping useful constants
shelly <- c('Brachiopoda', 'Anthozoa', 'Trilobita', 
            'Bivalvia', 'Gastropoda')#, 'Cephalopoda')
temp_range <- c(485.4, 419.2)          # ordovicain + silurian
hirnantian <- c(445.2, 443.8)

```


## Shelly occurrences 

The shelly groups are a mixture of phyla and classes. I want a single vector with the shelly identity of every observation.

```{r shelly}

occur_collect %<>%
  mutate(phylum_shelly = ifelse(phylum %in% shelly, phylum, NA),
         class_shelly = ifelse(class %in% shelly, class, NA),
         shelly = coalesce(phylum_shelly, class_shelly))

```

With this information I can plot occurrences over time, highlighted by their shelly type.

```{r vis_shelly}

occur_collect %>%
  group_by(shelly, bin_age) %>%
  count() %>%
  ggplot(aes(x = bin_age, y = n, 
             colour = shelly, fill = shelly)) +
  geom_col() +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  labs(x = 'Time (Mya)', 'Count')

occur_collect %>%
  group_by(shelly, bin_age) %>%
  count() %>%
  ggplot(aes(x = bin_age, y = n, 
             colour = shelly, fill = shelly)) +
  geom_col(position = 'fill') +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  labs(x = 'Time (Mya)', 'Proportion')

```

The oldest intervals in our dataset are mostly trilobites, while younger in the series there are more brachiopods.  There are some intervals that are absolutely dominated by individual groups.Additionally, corals become more present in younger intervals.

However, here's the catch -- the above plots are for all occurrences in the sense of abundance, and not unique taxonomic occurrences. Here's a redo of the above that focuses only on unique taxon occurrences. I'm going to filter to genus because that's such a thing in paleo.


```{r vis_shelly_unique}

occur_collect %>%
  group_by(shelly, bin_age) %>%
  filter(!duplicated(genus)) %>%
  count() %>%
  ggplot(aes(x = bin_age, y = n, 
             colour = shelly, fill = shelly)) +
  geom_col() +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  labs(x = 'Time (Mya)', 'Count')

occur_collect %>%
  group_by(shelly, bin_age) %>%
  filter(!duplicated(genus)) %>%
  count() %>%
  ggplot(aes(x = bin_age, y = n, 
             colour = shelly, fill = shelly)) +
  geom_col(position = 'fill') +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  labs(x = 'Time (Mya)', 'Proportion')

```

Mostly the same story as before, but some of the patterns we observed earlier are no longer as extreme. Makes sense because we're moving from abundance to incidence. 












```{r}

source('../R/rock_functions.r')
source('../R/rock_mung.r')
source('../R/fossil_functions.r')
source('../R/fossil_mung.r')



# constants
shelly <- c('Brachiopoda', 'Trilobita', 'Bivalvia', 'Gastropoda')
ord <- c(460.4, 443.8)
hirnantian <- 445.6

strat$fossils <- factor((strat$unit_id %in% taxon$unit))
taxon$group <- NA
for(ii in seq(length(shelly))) {
  taxon$group[taxon$phylum %in% shelly[ii]] <- shelly[ii]
  taxon$group[taxon$class %in% shelly[ii]] <- shelly[ii]
}



# the plot
unitgg <- ggplot(strat, aes(x = b_age, y = unit_id, colour = fossils)) 
unitgg <- unitgg + geom_segment(mapping = aes(xend = t_age, yend = unit_id),
                                alpha = 0.5)
unitgg <- unitgg + geom_point(mapping = aes(x = m_age))
unitgg <- unitgg + geom_point(data = taxon,
                              mapping = aes(x = mid_ma, 
                                            y = unit, 
                                            colour = NULL), 
                              shape = 4, alpha = 0.1, size = 1.1)
unitgg <- unitgg + facet_wrap( ~ group)
unitgg <- unitgg + labs(x = 'Mya', y = 'macrostrat unit')
unitgg <- unitgg + geom_vline(xintercept = hirnantian, 
                              linetype = 'dashed',
                              colour = 'blue')  # start of hirnantian
unitgg <- unitgg + coord_cartesian(xlim = ord)  # zoom in on ordovician
unitgg <- unitgg + theme(axis.text.y = element_blank(),
                         axis.ticks.y = element_blank())
unitgg <- unitgg + scale_colour_manual(values = blind)

# now figure out logical breaks
timerange <- abs(diff(ord))
brks <- timerange / 10
brks <- data.frame(x = seq(from = ord[2], to = ord[1], by = brks))
unitgg <- unitgg + geom_vline(data = brks, 
                              mapping = aes(xintercept = x), 
                              linetype = 'dotted', 
                              colour = 'darkred')
# mark beginning, end ordovician
odf <- data.frame(x = ord)
unitgg <- unitgg + geom_vline(data = odf, 
                              mapping = aes(xintercept = x),
                              colour = 'black', size = 1.5)
ggsave(plot = unitgg, filename = '../doc/figure/data_plot_brach.png',
       height = 5.5, width = 8)


```
