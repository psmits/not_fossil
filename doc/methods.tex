\documentclass[12pt,letterpaper]{article}

\usepackage{amsmath, amsthm, amsfonts, amssymb}
\usepackage{microtype, parskip, graphicx}
\usepackage[comma,numbers,sort&compress]{natbib}
\usepackage{lineno}
\usepackage{longtable}
\usepackage{docmute}
\usepackage{caption, subcaption, multirow, morefloats, rotating}
\usepackage{wrapfig}
\usepackage{hyperref}

\frenchspacing

\begin{document}


\section{Geological unit lithological descriptions}
Geological units were downloaded from Macrostrat platform CITATION 
% give api link


\section{Fossil occurrences in geological units}
Units records in Macrostrat have lists of the Paleobiology Database collections found in that unit. 

% give api link

Paleobiology Database




\section{Geologic unit covariates}


As reported in Macrostrat: max thickness (positive, real), areal extent (postive, real),
%contact with units above (binary), contact with units below (binary), 
%distance traveled between bottom and top coordinate in kilometers (positive, real), 
%if unit began in tropical latitudes (binary), 
if unit is strictly subsurface or not (binary), and 
the percent composition of carbonate and siliciclastic lithologies (compositional). 

Positive, real valued covariates were log plus one transformed, and then rescaled by subtracting mean and dividing by twice standard deviation. Rescaling the covariates has multiple advantages: 1) regression coefficients now describe the expected change in unit diversity per change in standard deviation of covariate, and 2) regression coefficients are comparable across covariates because they are all on the same scale (the expected standard deviation of a binary variable is 0.5).

Compositional covariates describe the percent lithological composition of the geologic units and are constrained to sum to 1; this constraint creates degrees-of-freedom issues and including these covariates without appropriate transformation creates two or more nonidentifiable parameters. To that end, the composition variables were isometric log-ratio transformed (following CITATION) which reduces the total number of variables to one less than original as composition is defined relaid to a baseline (percent carbonates). Unfortunately, the scale and interpretations of the associated regression coefficients are different from the other covariates, making direct comparison tricky.




\section{Binning geologic units}

Macrostrat units are ordered according to the underlying continuous-time age model CITATION. Geologic units, however, are not instantaneous and have a duration in time. Unfortunately the fossil collection information for each unit does not include within-unit superposition data; this means that the diversity within a geologic unit cannot be tracked trough time. Instead we have to focus on geologic units as the unit of our analysis. Importantly, units containing fossils tend to be shorter than units that do not (unpublished) most likely because the fossils help in correlating that unit in stratigraphic context which gives more precise temporal information; this helps with justifying our choice to assign each geologic unit to a single temporal bin. Specifically, we assign each geologic units to a single temporal bins based on which bin contained their midpoint. 



Geologic units were binned according to their midpoint age; macrostrat provides a top and bottom age, by averaging those we get the midpoint age.






\section{Modeling of the fossil diversity found in a geologic units}

A natual statistical distribution for discrete data is the Poisson distribution. 

Poisson parameterization makes strong assumptions about the mean-variance relationship of the data which is rarely found in life. To allow for possible overdisperssion in the data (variance greater than mean), we adopted the Negative Binomial distribution which can be derived as a mixture a Gamma and a Poisson distribution.

All geologic units we're analyzing have at least one species occurrence associated with it; this explicit observation restriction means that instead of a full distribution of counts from 0 to positive infinity, we instead have a truncated distribution ranging from 1 to positive infinity.


The probability mass function for the parameterization of the Negative Binomial distribution in terms of mean \(\mu\) and dispersion \(\phi\) is written as:
\begin{equation}
  \text{Negative Binomial}(y | \mu, \phi) = \binom{y + \phi - 1}{y} \frac{\mu}{\mu + \phi}^{\mu} \frac{\phi}{\mu + \phi}^{\phi}.
\end{equation}
We chose this parameterization of the Negative Binomial distribution because it has one of the simplest interpretations; the mean \(\mu\) is the expected species diversity observed in a geologic unit, and the amount of overdispersion is equal to the inverse of \(\phi\) scaled by the square of the mean. 

Our hierarchical/multi-level model can be characterized as a type of GLMM with varying-intercept and varying-slopes and the assumed data distribution is a zero-truncated Negative Binomial distribution.

The effects of the unit covariates are expressed as the regression coefficients \(\beta\) which were allowed to vary over time. The temporal structure of the covariates was modeled as a random walk prior on the matrix of time-level means \(\gamma\); a random-walk prior is a simple way of constraining the estimates for \(\beta_{t}\) given the estimate of \(\beta_{t - 1}\). Additionally, the scale parameters \(\sigma\) for each of the \(K\) coefficients are related to the rate of change over time; a low value of \(\sigma_{k}\) corresponds to little between time variance in the effect of that covariate on diversity while a large value of \(\sigma_{k}\) indicates that the effect of that covariate is inconsistent through time.
\begin{equation}
  \begin{aligned}
    \mu_{i} &= \exp(X_{i} \beta_{t[i]}) \\
    \beta_{t} &\sim \text{MVN}(\gamma_{t}, \Sigma) \\
    \gamma_{t, k} &\sim 
      \begin{cases}
        \mathcal{N}(0, \sigma_{K}) & \quad \text{if } t = 1 \\
        \mathcal{N}(\gamma_{t - 1, k}, \sigma_{k}) & \quad \text{if } t > 1
      \end{cases} \\
    \sigma_{k} &\sim \mathcal{N}^{+}(1). \\ 
  \end{aligned}
\end{equation}

The additional covariance between variation in the regression coefficients \(\beta\) over time that not accounted for by the random-walk prior on \(\gamma\) are modeled by the unknown/estimated covariance matrix \(\Sigma\). In order to improve sampling performance and choice of priors, the covariance matrix was decomposed into a vector of scales \(\tau\) and a correlation matrix \(\Omega\) as recommended by the Stan Manual CITATION. Their associated priors are as follows:
\begin{equation}
  \begin{aligned}
    \Sigma &= \text{diag}(\tau) \Omega \text{diag}{\tau} \\
    \Omega &\sim \text{LKJ}(2) \\
    \tau &\sim \mathcal{N}^{+}(1). \\
  \end{aligned}
\end{equation}

The LKJ distribution is a single parameter distribution of correlation matrices; values of the parameer close to 0 correspond to a uniform distribution across all possible correlations, and as values increase this distribution convergent on an identity matrix. This weakly-informative prior nudges our estimates towards a result of no correlation between covariate effects over time though is not sufficiently strong enough to prevent us inferring that kind of result.

Unless otherwise noted, all prior choices reflect our decision to use weakly-informative regularizing priors. Additionally, because all covariates are on approximately unit scale and we do not expect any of our regression coefficients to have magnitude greater than 2, more diffuse priors would serve no purpose and are unnecessary. Additionally, more diffuse priors would not reflect our actual expectations regarding the magnitude of covariate effects. Finally, the regularizing property of priors helps constrain our results such that we do not obtain spurious estimates of the covariate effects. Further statistical and philosophical backing for these prior choices is available HERE HERE AND HERE CITATION.


\subsection{Implementing model in Stan}

Non-centered parameterization helps with divergences b/c breaks mean from variance. Cost is additional parameter, but that parameter has good behavior. For the details of what that means and why it works check out Betancourt and Girolami 2013 and the Stan manual.

The above model specifications are modified as follows:
\begin{equation}
  \beta_{t} &= \gamma_{t} + z\Sigma
  \gamma_{t, k} &=
  \begin{cases}
    \sigma_{k} * \gamma^{'}_{t, k} & \quad \text{if } t = 1 \\
    \gamma_{t - 1, k} + \sigma_{k} * \gamma^{'}_{t, k} & \quad \text{if } t = 1 \\
  \end{cases} \\
  z ~ \mathcal{N}(0, 1) \\
  \gamma^{'} ~ \mathcal{N}(0, 1) \\
  \sigma_{k} &\sim \mathcal{N}^{+}(1). \\ 
\end{equation}

Adapt delta 0.999, tree depth 15, and stepsize 0.5.
