# Explore data

Now that's I've cleaned up the data a bunch, I'm going to explore some of the patterns in the data. I'm interested in how occurrence changes over time, when multiple last occurrences are in the same time bin, and geological unit lithological composition.

```{r import_clean, message = FALSE, results = 'hide'}

occur_collect <- read_csv(here::here('data', 'occurrences_clean.csv'))

# re-upping useful constants
shelly <- c('Brachiopoda', 'Anthozoa', 'Trilobita', 
            'Bivalvia', 'Gastropoda')#, 'Cephalopoda')
temp_range <- c(485.4, 419.2)          # ordovicain + silurian
hirnantian <- c(445.2, 443.8)

```


## Shelly occurrences 

The shelly groups are a mixture of phyla and classes. I want a single vector with the shelly identity of every observation.

```{r shelly}

occur_collect %<>%
  mutate(phylum_shelly = ifelse(phylum %in% shelly, phylum, NA),
         class_shelly = ifelse(class %in% shelly, class, NA),
         shelly = coalesce(phylum_shelly, class_shelly))

```

With this information I can plot occurrences over time, highlighted by their shelly type.

```{r vis_shelly}

occur_collect %>%
  group_by(shelly, bin_age) %>%
  count() %>%
  ggplot(aes(x = bin_age, y = n, 
             colour = shelly, fill = shelly)) +
  geom_col() +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  scale_x_reverse() +
  labs(x = 'Time (Mya)', y = 'Count')

occur_collect %>%
  group_by(shelly, bin_age) %>%
  count() %>%
  ggplot(aes(x = bin_age, y = n, 
             colour = shelly, fill = shelly)) +
  geom_col(position = 'fill') +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  scale_x_reverse() +
  labs(x = 'Time (Mya)', y = 'Proportion')

```

The oldest intervals in our dataset are mostly trilobites, while younger in the series there are more brachiopods.  There are some intervals that are absolutely dominated by individual groups.Additionally, corals become more present in younger intervals.

However, here's the catch -- the above plots are for all occurrences in the sense of abundance, and not unique taxonomic occurrences. Here's a redo of the above that focuses only on unique taxon occurrences. I'm going to filter to genus because that's such a thing in paleo.


```{r vis_shelly_unique}

occur_collect %>%
  group_by(shelly, bin_age) %>%
  filter(!duplicated(genus)) %>%
  count() %>%
  ggplot(aes(x = bin_age, y = n, 
             colour = shelly, fill = shelly)) +
  geom_col() +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  scale_x_reverse() +
  labs(x = 'Time (Mya)', y = 'Count')

occur_collect %>%
  group_by(shelly, bin_age) %>%
  filter(!duplicated(genus)) %>%
  count() %>%
  ggplot(aes(x = bin_age, y = n, 
             colour = shelly, fill = shelly)) +
  geom_col(position = 'fill') +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
  scale_x_reverse() +
  labs(x = 'Time (Mya)', y = 'Proportion')

```

Mostly the same story as before, but some of the patterns we observed earlier are no longer as extreme. Makes sense because we're moving from abundance to incidence. 


## Last occurrences

When is the last time each genus occurs in our dataset? Group the tibble by genus and the calculate the *minimum* time bin. Minimum because time bin age *decreases* as we approach the present.

```{r lad}

lad <- 
  occur_collect %>%
  group_by(genus) %>%
  dplyr::summarize(lad = min(bin_age)) %>%
  group_by(lad) %>%
  count() %>%
  ungroup() %>%
  arrange(desc(lad)) %>%
  mutate(n_cum = cumsum(n))

lad %>%
  ggplot(aes(x = lad, y = n)) +
  geom_line() +
  scale_x_reverse() +
  labs(x = 'Time (Mya)', y = 'LAD Count')

lad %>%
  ggplot(aes(x = lad, y = n_cum)) +
  geom_line() +
  scale_x_reverse() +
  labs(x = 'Time (Mya)', y = 'LAD Cummulative')

```

And again by shelly group.

```{r lad_shelly}

lad_shelly <- 
  occur_collect %>%
  group_by(genus, shelly) %>%
  dplyr::summarize(lad = min(bin_age)) %>%
  group_by(shelly) %>%
  ungroup() %>%
  group_by(shelly, lad) %>%
  count() %>%
  ungroup() %>%
  group_by(shelly) %>%
  arrange(desc(lad)) %>%
  mutate(n_cum = cumsum(n)) %>%
  ungroup()

lad_shelly %>%
  ggplot(aes(x = lad, y = n)) +
  geom_line() +
  facet_wrap(~ shelly) +
  scale_x_reverse() +
  labs(x = 'Time (Mya)', y = 'LAD Count')

lad_shelly %>%
  ggplot(aes(x = lad, y = n_cum)) +
  geom_line() +
  facet_wrap(~ shelly) +
  scale_x_reverse() +
  labs(x = 'Time (Mya)', y = 'LAD Cummulative')

```







```{r}

#source('../R/rock_functions.r')
#source('../R/rock_mung.r')
#source('../R/fossil_functions.r')
#source('../R/fossil_mung.r')



```
